from prefect import flow
from tasks.transfermarkt import ingest_transfers_by_date
from datetime import datetime, timedelta
import os
import pandas as pd
import time

@flow
def transfermarkt_backfill_manual():

    missing_dates = [
        # '2000-02-06',
        # '2000-02-07',
        # '2000-04-07',
        # '2000-05-10',
        # '2000-07-01',
        # '2000-07-06',
        # '2000-07-11',
        # '2000-07-13',
        # '2000-08-08',
        # '2000-08-09',
        # '2000-08-10',
        # '2000-09-29',
        # '2000-10-05',
        # '2000-10-13',
        # '2000-10-18',
        # '2000-11-09',
        # '2000-12-04',
        # '2001-01-11',
        # '2001-02-09',
        # '2001-03-08',
        # '2001-05-19',
        # '2001-07-01',
        # '2001-07-05',
        # '2001-07-07',
        # '2001-07-09',
        # '2001-07-13',
        # '2001-08-09',
        # '2001-08-17',
        # '2001-10-01',
        # '2001-10-10',
        # '2001-11-29',
        # '2001-12-31',
        # '2002-01-01',
        # '2002-01-11',
        # '2002-01-12',
        # '2002-01-25',
        # '2002-01-30',
        # '2002-02-10',
        # '2002-02-12',
        # '2002-03-01',
        # '2002-04-10',
        # '2002-06-13',
        # '2002-07-01',
        # '2002-07-05',
        # '2002-07-08',
        # '2002-07-09',
        # '2002-07-10',
        # '2002-07-11',
        # '2002-07-12',
        # '2002-07-13',
        # '2002-07-20',
        # '2002-08-01',
        # '2002-08-06',
        # '2002-08-08',
        # '2002-08-09',
        # '2002-08-10',
        # '2002-08-12',
        # '2002-08-14',
        # '2002-08-16',
        # '2002-08-21',
        # '2002-08-28',
        # '2002-09-06',
        # '2002-09-11',
        # '2002-09-12',
        # '2002-09-13',
        # '2002-10-12',
        # '2003-01-01',
        # '2003-01-07',
        # '2003-01-08',
        # '2003-01-09',
        # '2003-01-11',
        # '2003-01-12',
        # '2003-01-13',
        # '2003-07-01',
        # '2003-07-07',
        # '2003-07-08',
        # '2003-07-10',
        # '2003-07-11',
        # '2003-07-13',
        # '2003-07-14',
        # '2003-07-16',
        # '2003-08-01',
        # '2003-08-05',
        # '2003-08-07',
        # '2003-08-10',
        # '2003-08-15',
        # '2003-08-22',
    ]

    for missing_date in missing_dates:

        transfers = ingest_transfers_by_date(missing_date)

        if (len(transfers)):

            filepath = f"/home/prefect/.prefect/raw/transfers_by_day/"
            os.makedirs(os.path.dirname(filepath), exist_ok=True)

            df = pd.DataFrame(transfers)
            df.to_parquet(filepath, partition_cols=['y', 'm', 'd'])

        time.sleep(10)

if __name__ == '__main__':
    transfermarkt_backfill_manual()